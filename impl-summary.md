# JW_CAD Viewer å®Ÿè£…æˆ¦ç•¥ - ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

## ğŸ¯ æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: Pure TypeScriptå®Ÿè£…

### çµè«–

**WASMã¯ä¸è¦ã§ã™ã€‚** Pure TypeScript + Canvas 2D APIã§ååˆ†é«˜é€Ÿã‹ã¤ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹å¯èƒ½ãªJWWãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã‚’å®Ÿè£…ã§ãã¾ã™ã€‚

## ãªãœWASMã‚’ä½¿ã‚ãªã„ã®ã‹?

### 1. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çš„ã«ä¸è¦

```
JWWãƒ•ã‚¡ã‚¤ãƒ«ã®ç‰¹æ€§:
- ã‚µã‚¤ã‚º: é€šå¸¸ < 5MB
- ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ•°: é€šå¸¸ < 10,000
- ãƒ‘ãƒ¼ã‚¹å‡¦ç†: 1å›ã®ã¿(ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯èƒ½)

TypeScriptã§ã®å‡¦ç†æ™‚é–“:
- å°è¦æ¨¡å›³é¢(1,000ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£): < 100ms
- ä¸­è¦æ¨¡å›³é¢(10,000ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£): < 1s
- å¤§è¦æ¨¡å›³é¢: Web Workerã§å¯¾å¿œå¯èƒ½
```

### 2. é–‹ç™ºåŠ¹ç‡ãŒé«˜ã„

|é …ç›®      |TypeScript          |WASM|
|--------|--------------------|----|
|ãƒ‡ãƒãƒƒã‚°    |å®¹æ˜“                  |å›°é›£  |
|ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹  |å®¹æ˜“                  |å›°é›£  |
|ãƒ“ãƒ«ãƒ‰ãƒã‚§ãƒ¼ãƒ³ |ã‚·ãƒ³ãƒ—ãƒ«                |è¤‡é›‘  |
|é–‹ç™ºè€…ã®å‚å…¥éšœå£|ä½ã„                  |é«˜ã„  |
|ãƒã‚¤ãƒŠãƒªå‡¦ç†  |DataView/ArrayBuffer|åŒç­‰  |

### 3. æ—¢å­˜å®Ÿè£…ã®æ´»ç”¨

```
JwwExchange (C#)
  â†“ ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‚ç…§
TypeScriptå®Ÿè£…
  â†“ ãã®ã¾ã¾åˆ©ç”¨
Web + iOS (Capacitor)
```

C#ã‹ã‚‰TypeScriptã¸ã®ç§»æ¤ã¯ã€C++ã‹ã‚‰WASMã¸ã®ç§»æ¤ã‚ˆã‚Šé¥ã‹ã«å®¹æ˜“ã§ã™ã€‚

## ğŸ“‹ å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### ãƒ•ã‚§ãƒ¼ã‚º1: ã‚³ã‚¢å®Ÿè£… (3-4é€±é–“)

```typescript
// 1. ãƒã‚¤ãƒŠãƒªãƒªãƒ¼ãƒ€ãƒ¼
class JwwBinaryReader {
  readByte(): number;
  readInt16(): number;
  readInt32(): number;
  readDouble(): number;
  readString(length: number): string; // Shift-JISå¯¾å¿œ
}

// 2. ãƒ‘ãƒ¼ã‚µãƒ¼
class JwwParser {
  async parse(file: File): Promise<JwwDocument> {
    // ãƒ˜ãƒƒãƒ€ãƒ¼ â†’ ãƒ¬ã‚¤ãƒ¤ãƒ¼ â†’ ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
  }
}

// 3. ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼
class JwwRenderer {
  render(document: JwwDocument): void {
    // Canvas 2D APIã§æç”»
  }
}
```

**å®Ÿè£…å„ªå…ˆé †ä½:**

1. ç·šåˆ† (Line) â† æœ€é‡è¦
1. å†† (Circle)
1. å††å¼§ (Arc)
1. ãƒ†ã‚­ã‚¹ãƒˆ (Text) â† Shift-JISå¯¾å¿œå¿…é ˆ
1. ãã®ä»–(æ¥•å††ã€å¯¸æ³•ç·šã€ãƒãƒªãƒ©ã‚¤ãƒ³â€¦)

### ãƒ•ã‚§ãƒ¼ã‚º2: UIå®Ÿè£… (1é€±é–“)

```typescript
// React/Vue/Svelteã©ã‚Œã§ã‚‚å¯
export const JwwViewer: React.FC = () => {
  const [document, setDocument] = useState<JwwDocument | null>(null);
  
  return (
    <>
      <FileInput onLoad={setDocument} />
      <Canvas document={document} />
      <LayerPanel layers={document?.layers} />
    </>
  );
};
```

**æ©Ÿèƒ½:**

- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ»ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
- ãƒ‘ãƒ³ãƒ»ã‚ºãƒ¼ãƒ ãƒ»å›è»¢
- ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ(PNG, PDF)

### ãƒ•ã‚§ãƒ¼ã‚º3: æœ€é©åŒ– (1-2é€±é–“)

```typescript
// Web Workerã§ãƒ‘ãƒ¼ã‚¹å‡¦ç†
// main.ts
const worker = new Worker('jww-parser.worker.ts');
worker.postMessage({ file });

// jww-parser.worker.ts
self.addEventListener('message', async (e) => {
  const document = await parse(e.data.file);
  self.postMessage({ document });
});
```

**æœ€é©åŒ–é …ç›®:**

- Web Worker(å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ç”¨)
- ã‚ªãƒ•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³Canvas(é™çš„æç”»ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥)
- ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã‚«ãƒªãƒ³ã‚°(è¡¨ç¤ºç¯„å›²å¤–ã‚’ã‚¹ã‚­ãƒƒãƒ—)

### ãƒ•ã‚§ãƒ¼ã‚º4: ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  (1é€±é–“)

```bash
# Capacitorã§ãƒ©ãƒƒãƒ—
npx cap init
npx cap add ios
npx cap open ios
```

**å¯¾å¿œ:**

- PWAåŒ–(Service Worker)
- iOSå¯¾å¿œ(Capacitor)
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹

## ğŸ”‘ æˆåŠŸã®éµ

### 1. JwwExchangeã®æ´»ç”¨

```
JwwExchange/JwwData.cs
  â†“ ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å‚è€ƒ
types.ts

JwwExchange/JwwSen.cs (ç·šåˆ†)
  â†“ ãƒ‘ãƒ¼ã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‚è€ƒ
jww-parser.ts ã® parseLine()
```

**é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«:**

- `JwwData.cs`: ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ 
- `JwwSen.cs`: ç·šåˆ†ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
- `JwwCircle.cs`: å††ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
- `JwwMoji.cs`: ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

### 2. å®Ÿãƒ•ã‚¡ã‚¤ãƒ«ã§ã®æ¤œè¨¼

```typescript
// ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™º
describe('JwwParser', () => {
  it('should parse simple line', async () => {
    const file = await loadTestFile('simple-line.jww');
    const doc = await parser.parse(file);
    
    expect(doc.entities[0]).toMatchObject({
      type: 'line',
      startX: 0,
      startY: 0,
      endX: 100,
      endY: 100
    });
  });
});
```

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«:**

- ã‚·ãƒ³ãƒ—ãƒ«ãªç·šåˆ†ã®ã¿
- å††ãƒ»å††å¼§ã‚’å«ã‚€å›³é¢
- æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆã‚’å«ã‚€å›³é¢
- è¤‡é›‘ãªå®Ÿéš›ã®å›³é¢

### 3. æ®µéšçš„ãªå®Ÿè£…

```
Step 1: ç·šåˆ†ã®ã¿
  â†“ å‹•ä½œç¢ºèª
Step 2: å††ãƒ»å††å¼§è¿½åŠ 
  â†“ å‹•ä½œç¢ºèª
Step 3: ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ (Shift-JISå¯¾å¿œ)
  â†“ å‹•ä½œç¢ºèª
Step 4: ãã®ä»–ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
```

å„ã‚¹ãƒ†ãƒƒãƒ—ã§å®Ÿéš›ã®JWWãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã£ã¦æ¤œè¨¼ã—ã¾ã™ã€‚

## âš ï¸ æ³¨æ„ç‚¹

### æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°

```typescript
// Shift-JISãƒ‡ã‚³ãƒ¼ãƒ‰ãŒå¿…é ˆ
// ãƒ–ãƒ©ã‚¦ã‚¶ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚µãƒãƒ¼ãƒˆãŒãªã„å ´åˆã¯polyfillä½¿ç”¨
import { decode } from 'encoding-japanese';

const text = decode(bytes, {
  from: 'SJIS',
  to: 'UNICODE'
});
```

**æ¨å¥¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª:**

- encoding-japanese: https://github.com/polygonplanet/encoding.js

### JWWãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®æ›–æ˜§æ€§

```typescript
// ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å……å®Ÿ
class JwwParser {
  constructor(options: {
    strictMode: boolean = false;
    skipInvalidEntities: boolean = true;
  }) {}
  
  private parseEntity(reader: JwwBinaryReader) {
    try {
      // ãƒ‘ãƒ¼ã‚¹å‡¦ç†
    } catch (error) {
      if (this.options.skipInvalidEntities) {
        console.warn('Skipping invalid entity');
        return null;
      }
      throw error;
    }
  }
}
```

### LibreCAD jwwlibã®è„†å¼±æ€§

```
LibreCAD jwwlibã«ã¯è¤‡æ•°ã®ãƒãƒƒãƒ•ã‚¡ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼è„†å¼±æ€§ãŒã‚ã‚Šã¾ã™:
- CVE-2021-45341 (CDataMoji)
- CVE-2021-45342 (CDataList)

TypeScriptå®Ÿè£…ã§ã¯:
- å¢ƒç•Œãƒã‚§ãƒƒã‚¯ã‚’å¿…ãšå®Ÿæ–½
- ArrayBufferã®ç¯„å›²å¤–ã‚¢ã‚¯ã‚»ã‚¹ã¯è‡ªå‹•çš„ã«ã‚¨ãƒ©ãƒ¼
- ã‚ˆã‚Šå®‰å…¨
```

## ğŸ“Š æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### å¿…é ˆ

```json
{
  "dependencies": {
    "encoding-japanese": "^2.0.0"
  },
  "devDependencies": {
    "typescript": "^5.0.0",
    "vite": "^5.0.0",
    "vitest": "^1.0.0"
  }
}
```

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³(ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯)

- **React**: è±Šå¯Œãªã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ 
- **Vue**: ã‚·ãƒ³ãƒ—ãƒ«ã§å­¦ç¿’æ›²ç·šãŒç·©ã‚„ã‹
- **Svelte**: æœ€å°ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚º

### iOSå¯¾å¿œ

```json
{
  "dependencies": {
    "@capacitor/core": "^6.0.0",
    "@capacitor/ios": "^6.0.0",
    "@capacitor/filesystem": "^6.0.0"
  }
}
```

## ğŸ¨ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         UI Layer (React/Vue)        â”‚
â”‚  FileInput â”‚ Canvas â”‚ LayerPanel   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Application Layer             â”‚
â”‚  JwwViewer â”‚ ViewportController     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Core Layer                  â”‚
â”‚  JwwParser â”‚ JwwRenderer            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Infrastructure Layer           â”‚
â”‚  BinaryReader â”‚ CoordinateConverter â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ˆ æœŸå¾…ã•ã‚Œã‚‹çµæœ

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

```
ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: 1MB
ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ•°: 5,000
ãƒ‘ãƒ¼ã‚¹æ™‚é–“: ~200ms
åˆå›æç”»: ~50ms
å†æç”»(ãƒ‘ãƒ³/ã‚ºãƒ¼ãƒ ): ~16ms (60fps)
```

### ã‚³ãƒ¼ãƒ‰ã‚µã‚¤ã‚º

```
jww-parser.ts: ~500è¡Œ
jww-renderer.ts: ~400è¡Œ
binary-reader.ts: ~200è¡Œ
types.ts: ~300è¡Œ
total: ~1,400è¡Œ

gzipåœ§ç¸®å¾Œ: ~30KB
```

### é–‹ç™ºæœŸé–“

```
ãƒ•ã‚§ãƒ¼ã‚º1 (ã‚³ã‚¢): 3-4é€±é–“
ãƒ•ã‚§ãƒ¼ã‚º2 (UI): 1é€±é–“
ãƒ•ã‚§ãƒ¼ã‚º3 (æœ€é©åŒ–): 1-2é€±é–“
ãƒ•ã‚§ãƒ¼ã‚º4 (iOS): 1é€±é–“
---
åˆè¨ˆ: 6-8é€±é–“
```

## ğŸš€ å§‹ã‚æ–¹

### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã®ç¢ºèª

```bash
# æä¾›ã•ã‚ŒãŸãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã‚’ç¢ºèª
cd jww-viewer-prototype
ls src/
# types.ts, binary-reader.ts, jww-parser.ts, jww-renderer.ts
```

### ã‚¹ãƒ†ãƒƒãƒ—2: JwwExchangeã®ç ”ç©¶

```bash
# JwwExchangeã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
git clone https://github.com/JinkiKeikaku/JwwExchange.git

# ä¸»è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
JwwExchange/
  â”œâ”€â”€ JwwData.cs      # ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ§‹é€ 
  â”œâ”€â”€ JwwSen.cs       # ç·šåˆ†
  â”œâ”€â”€ JwwCircle.cs    # å††
  â””â”€â”€ JwwMoji.cs      # ãƒ†ã‚­ã‚¹ãƒˆ
```

### ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™

```
1. JW_CADã§ç°¡å˜ãªå›³é¢ã‚’ä½œæˆ
2. ç·šåˆ†ã®ã¿ã®å›³é¢ (simple-line.jww)
3. å††ã‚’å«ã‚€å›³é¢ (circle-test.jww)
4. æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆã‚’å«ã‚€å›³é¢ (text-test.jww)
```

### ã‚¹ãƒ†ãƒƒãƒ—4: å®Ÿè£…é–‹å§‹

```typescript
// 1. ç·šåˆ†ã®ãƒ‘ãƒ¼ã‚¹ã‚’å®Ÿè£…
// 2. ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã§æ¤œè¨¼
// 3. ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’å®Ÿè£…
// 4. å‹•ä½œç¢ºèª
// 5. æ¬¡ã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚¿ã‚¤ãƒ—ã¸
```

## çµè«–

JW_CADãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã¯ **Pure TypeScriptå®Ÿè£…ã§ååˆ†** ã§ã™ã€‚

**ãƒ¡ãƒªãƒƒãƒˆ:**

- âœ… ååˆ†ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- âœ… é–‹ç™ºãƒ»ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãŒå®¹æ˜“
- âœ… ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ“ãƒ«ãƒ‰ãƒã‚§ãƒ¼ãƒ³
- âœ… ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å¯¾å¿œ
- âœ… è±Šå¯Œãªã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ 

**WASMãŒå¿…è¦ãªã‚±ãƒ¼ã‚¹:**

- âŒ è©²å½“ãªã—(JWWãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã®å ´åˆ)

æä¾›ã—ãŸãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã‚³ãƒ¼ãƒ‰ã‚’å‡ºç™ºç‚¹ã¨ã—ã¦ã€JwwExchangeã‚’å‚ç…§ã—ãªãŒã‚‰æ®µéšçš„ã«å®Ÿè£…ã‚’é€²ã‚ã¦ãã ã•ã„ã€‚
